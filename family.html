<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>KUBUMIX FAMILY</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root { 
            --pink: #ff007f; 
            --bg: #0f1218; 
            --tg-dark: #181c26; 
            --my-grad: linear-gradient(135deg, #ff007f 0%, #7000ff 100%);
            --other-msg: #212630;
            --text: #ffffff; 
        }
        
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: 'Roboto', sans-serif; height: 100dvh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        .russo { font-family: 'Russo One', sans-serif; text-transform: uppercase; }

        /* HEADER */
        header { 
            background: rgba(24, 28, 38, 0.9); backdrop-filter: blur(10px);
            height: 60px; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border-bottom: 1px solid rgba(255, 0, 127, 0.3); 
            position: fixed; top: 0; width: 100%; z-index: 1000;
        }
        .status-dot { width: 8px; height: 8px; background: #00ff00; border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 0 10px #00ff00; }

        /* CHAT AREA */
        .app-content { 
            flex: 1; overflow-y: auto; padding: 75px 12px 140px; 
            display: flex; flex-direction: column; gap: 10px;
            max-width: 600px; margin: 0 auto; width: 100%;
        }

        /* MESSAGES */
        .post { 
            max-width: 85%; padding: 10px 14px; border-radius: 18px; 
            position: relative; box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .my-post { align-self: flex-end; background: var(--my-grad); border-bottom-right-radius: 4px; }
        .other-post { align-self: flex-start; background: var(--other-msg); border-bottom-left-radius: 4px; border: 1px solid #333; }

        .sys-msg { align-self: center; background: rgba(255,255,255,0.05); color: var(--dim); font-size: 11px; padding: 5px 15px; border-radius: 20px; margin: 10px 0; }

        .post-author { font-size: 11px; font-weight: bold; color: var(--pink); margin-bottom: 3px; }
        .post-text { font-size: 15px; line-height: 1.4; }
        .post-img { width: 100%; border-radius: 12px; margin-top: 8px; }

        .post-footer { display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-top: 5px; opacity: 0.6; font-size: 10px; }
        .btn-del { color: #ff4444; background: none; border: none; cursor: pointer; }

        /* INPUT AREA */
        .input-area { 
            position: fixed; bottom: 0; width: 100%; 
            background: #12141a; padding: 10px 15px 30px; 
            display: flex; flex-direction: column; gap: 8px;
            border-top: 1px solid #222; z-index: 1000;
        }
        .emoji-bar { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; }
        .emoji { font-size: 22px; cursor: pointer; }

        .input-row { display: flex; align-items: flex-end; gap: 10px; }
        .input-container { 
            background: #000; flex: 1; border-radius: 22px; 
            padding: 8px 15px; display: flex; align-items: center; border: 1px solid #333;
        }
        .v-input { flex: 1; background: none; border: none; color: #fff; font-size: 16px; outline: none; resize: none; max-height: 100px; }
        
        .send-btn { 
            background: var(--pink); width: 45px; height: 45px; 
            border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; border: none; cursor: pointer;
            box-shadow: 0 0 15px var(--pink);
        }

        .hidden { display: none !important; }
        #auth-gate { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

<div id="auth-gate">
    <div style="background:#181c26; padding:30px; border-radius:25px; width:85%; max-width:320px; text-align:center; border:1px solid #333;">
        <h2 class="russo" style="color:var(--pink)">KUBUMIX FAMILY</h2>
        <input type="email" id="l-email" style="width:100%; padding:12px; border-radius:10px; border:1px solid #333; background:#000; color:#fff; margin-top:15px;" placeholder="Email">
        <input type="password" id="l-pass" style="width:100%; padding:12px; border-radius:10px; border:1px solid #333; background:#000; color:#fff; margin-top:10px;" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="appAuth('login')" style="width:100%; margin-top:20px; padding:12px; border-radius:10px; background:var(--pink); color:#fff; border:none; font-weight:bold;">–£–í–Ü–ô–¢–ò</button>
        <div style="color:#666; font-size:12px; margin-top:15px;" onclick="appAuth('reg')">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç</div>
    </div>
</div>

<header>
    <div class="russo" style="font-size: 15px;">KUBUMIX <span style="color:var(--pink)">FAMILY</span></div>
    <div style="font-size:10px; color:var(--pink)" id="user-display"><span class="status-dot"></span>Online</div>
</header>

<div class="app-content hidden" id="app">
    <div id="wall-content" style="display: flex; flex-direction: column;"></div>
</div>

<div class="input-area hidden" id="nav">
    <div class="emoji-bar">
        <span class="emoji" onclick="addE('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span class="emoji" onclick="addE('üòÇ')">üòÇ</span>
        <span class="emoji" onclick="addE('üî•')">üî•</span>
        <span class="emoji" onclick="addE('üòò')">üòò</span>
        <span class="emoji" onclick="addE('üòç')">üòç</span>
        <span class="emoji" onclick="addE('üò≠')">üò≠</span>
    </div>
    <div class="input-row">
        <div class="input-container">
            <label for="f-input" style="font-size:22px; margin-right:10px;">üìé</label>
            <input type="file" id="f-input" accept="image/*" class="hidden">
            <textarea id="post-body" class="v-input" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." rows="1"></textarea>
        </div>
        <button class="send-btn" onclick="sendPost()">üöÄ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue, serverTimestamp, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

    const cfg = {
        apiKey: "AIzaSyA_LwiXGQge-0zC1xqZFyeUmZWhKs4oYgY",
        authDomain: "kubumixapp.firebaseapp.com",
        databaseURL: "https://kubumixapp-default-rtdb.firebaseio.com",
        projectId: "kubumixapp",
        storageBucket: "kubumixapp.appspot.com"
    };

    const fire = initializeApp(cfg);
    const auth = getAuth(fire);
    const db = getDatabase(fire);
    const store = getStorage(fire);

    let uName = localStorage.getItem('kb_name') || "–•—Ç–æ—Å—å";
    let isInitialLoad = true;

    // –ó–∞–ø–∏—Ç –Ω–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –±—Ä–∞—É–∑–µ—Ä–∞
    if (Notification.permission !== "granted") Notification.requestPermission();

    window.addE = (e) => document.getElementById('post-body').value += e;

    window.appAuth = async (t) => {
        const mail = document.getElementById('l-email').value, pass = document.getElementById('l-pass').value;
        try {
            if(t === 'login') await signInWithEmailAndPassword(auth, mail, pass);
            else {
                const n = prompt("–Ø–∫ —Ç–µ–±–µ –∑–≤–∞—Ç–∏?"); if(!n) return;
                const r = await createUserWithEmailAndPassword(auth, mail, pass);
                await set(ref(db, 'users/' + r.user.uid), { name: n });
                uName = n; localStorage.setItem('kb_name', n);
            }
        } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞"); }
    };

    onAuthStateChanged(auth, (user) => {
        if(user) {
            document.getElementById('auth-gate').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('nav').classList.remove('hidden');
            
            onValue(ref(db, 'users/' + user.uid), s => {
                if(s.val()) {
                    uName = s.val().name;
                    // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤—Ö—ñ–¥
                    push(ref(db, 'family/wall'), { type: 'sys', text: uName + " –∑–∞–π—à–æ–≤(–ª–∞) —É –¥–æ–¥–∞—Ç–æ–∫", time: serverTimestamp() });
                }
            });
            loadWall();
        }
    });

    window.sendPost = async () => {
        const t = document.getElementById('post-body').value, f = document.getElementById('f-input').files[0];
        if(!t.trim() && !f) return;
        let url = null;
        if(f) {
            const sr = sRef(store, 'p/' + Date.now());
            await uploadBytes(sr, f);
            url = await getDownloadURL(sr);
        }
        await push(ref(db, 'family/wall'), { uid: auth.currentUser.uid, author: uName, text: t, image: url, time: serverTimestamp() });
        document.getElementById('post-body').value = "";
        document.getElementById('f-input').value = "";
    };

    function loadWall() {
        const wallRef = ref(db, 'family/wall');
        
        // –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –¥–ª—è –∑–≤—É–∫—É —Ç–∞ —Å–ø–æ–≤—ñ—â–µ–Ω—å
        onChildAdded(wallRef, (data) => {
            if (isInitialLoad) return;
            const msg = data.val();
            if (msg.uid !== auth.currentUser.uid) {
                document.getElementById('notif-sound').play();
                if (Notification.permission === "granted") {
                    new Notification("KUBUMIX FAMILY", { body: msg.author + ": " + msg.text });
                }
            }
        });

        onValue(wallRef, (snap) => {
            const wall = document.getElementById('wall-content');
            wall.innerHTML = "";
            snap.forEach((child) => {
                const d = child.val();
                if(d.type === 'sys') {
                    wall.innerHTML += `<div class="sys-msg">${d.text}</div>`;
                } else {
                    const isMy = d.uid === auth.currentUser.uid;
                    const time = d.time ? new Date(d.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";
                    wall.innerHTML += `
                        <div class="post ${isMy ? 'my-post' : 'other-post'}">
                            ${!isMy ? `<div class="post-author">${d.author}</div>` : ''}
                            <div class="post-text">${d.text}</div>
                            ${d.image ? `<img src="${d.image}" class="post-img">` : ''}
                            <div class="post-footer">
                                <span>${time}</span>
                                ${isMy ? `<span class="btn-del" onclick="deletePost('${child.key}')">‚úï</span>` : ''}
                            </div>
                        </div>
                    `;
                }
            });
            isInitialLoad = false;
            const app = document.getElementById('app');
            app.scrollTop = app.scrollHeight;
        });
    }

    window.deletePost = (id) => { if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏?")) remove(ref(db, 'family/wall/' + id)); };
</script>
</body>
</html>